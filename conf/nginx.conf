master_process on;

worker_processes 1;
worker_cpu_affinity auto;

error_log logs/error.log debug;

events {
    accept_mutex off;
    worker_connections 10620;
}

worker_rlimit_nofile 20480;

worker_shutdown_timeout 3;

http {
    include mime.types;

    lua_package_path  "/usr/local/openresty/luajit/share/luajit-2.1.0-beta3/?.lua;/usr/local/openresty/luajit/share/luajit-2.1.0-beta3/?/init.lua;/usr/local/openresty/lualib/?.lua;/usr/local/openresty/lualib/?/init.lua;$prefix/resty/?.lua;$prefix/apiok/?.lua;$prefix/deps/share/lua/5.1/?.lua;$prefix/?.lua;/usr/share/lua/5.1/?.lua;;";
    lua_package_cpath "/usr/local/openresty/luajit/lib/lua/5.1/?.so;/usr/local/openresty/lualib/?.so;$prefix/resty/?.so;$prefix/deps/lib64/lua/5.1/?.so;$prefix/deps/lib/lua/5.1/?.so;/usr/lib64/lua/5.1/?.so;/usr/lib/lua/5.1/?.so;;";

    log_format main '$remote_addr\t$http_x_forwarded_for\t$time_iso8601\t$scheme://$http_host\t$request\t$request_length\t'
    '$http_referer\t$http_user_agent\t$connection_requests\t$upstream_cache_status\t$status\t'
    '$request_time\t$upstream_response_time\t$bytes_sent\t$body_bytes_sent\t$server_name\t'
    '$upstream_addr\t$upstream_status\t$request_id\t';

    access_log logs/access.log main;

    resolver 8.8.8.8 114.114.114.114 ipv6=off;

    client_max_body_size 0;

    real_ip_header X-Real-IP;
    set_real_ip_from 127.0.0.1;
    set_real_ip_from unix:;

    more_set_headers 'Server: APIOK API Gateway';

    lua_code_cache on;

    lua_shared_dict plugin_limit_conn  50m;
    lua_shared_dict plugin_limit_req   50m;
    lua_shared_dict plugin_limit_count 50m;
    lua_shared_dict upstream_health_check 10m;
    lua_shared_dict upstream_worker_event 10m;
    lua_shared_dict prometheus_metrics 10m;
    lua_shared_dict worker_events 10m;

    # Proxy cache configuration
    # proxy_cache_path /tmp/nginx_cache levels=1:2 keys_zone=apiok_cache:100m max_size=1g inactive=60m use_temp_path=off;

    upstream apiok_backend {
        server 0.0.0.0:10999;
        balancer_by_lua_block {
            apiok.http_balancer()
        }
        keepalive 1024;
    }

    upstream apiok_admin {
        server 127.0.0.1:3000;
    }

    init_by_lua_block {
        apiok = require "apiok.apiok"
        apiok.init()
    }

    init_worker_by_lua_block {
        apiok.init_worker()
    }

    server {
        listen 10999;

        location / {
            content_by_lua_block {
                ngx.status = 500
                ngx.header["Content-Type"] = "text/html"
                ngx.say("Upstream Error!")
            }
        }
    }

    server {
        listen 8080;

        location / {
            proxy_pass http://apiok_admin;
        }

        location /apiok/admin {
            content_by_lua_block {
                apiok.http_admin()
            }
        }
    }

    server {
        listen 80;
        listen 443 ssl;

        ssl_certificate      cert/apiok.crt;
        ssl_certificate_key  cert/apiok.key;
        ssl_session_cache    shared:SSL:10m;
        ssl_session_timeout  10m;

        ssl_protocols        TLSv1 TLSv1.1 TLSv1.2;
        ssl_ciphers          HIGH:!aNULL:!MD5:!kEDH;

        ssl_certificate_by_lua_block {
             apiok.ssl_certificate()
        }

        location / {
            add_header X-Request-Id $request_id;

            set $client_max_body_size '';

            access_by_lua_block {
                apiok.http_access()
            }

            header_filter_by_lua_block {
                apiok.http_header_filter()
            }

            body_filter_by_lua_block {
                apiok.http_body_filter()
            }

            log_by_lua_block {
                apiok.http_log()
            }

            set $upstream_scheme             'http';
            set $upstream_host               $host;
            set $upstream_upgrade            '';
            set $upstream_connection         '';
            set $upstream_uri                '';
            set $proxy_cache_var             '';
            set $proxy_cache_key_var         '';
            set $proxy_cache_valid_var       '';
            set $proxy_cache_bypass_var      '';
            set $proxy_no_cache_var          '';

            proxy_http_version 1.1;
            proxy_buffering    on;
            proxy_cache        $proxy_cache_var;
            proxy_cache_key    $proxy_cache_key_var;
            proxy_cache_valid  200 302 10m;
            proxy_cache_valid  404 1m;
            proxy_cache_valid  any 5m;
            proxy_cache_bypass $proxy_cache_bypass_var;
            proxy_no_cache     $proxy_no_cache_var;
            proxy_set_header   Host              $upstream_host;
            proxy_set_header   Upgrade           $upstream_upgrade;
            proxy_set_header   Connection        $upstream_connection;
            proxy_set_header   X-Real-IP         $remote_addr;
            proxy_set_header   X-Request-Id      $request_id;
            proxy_pass_header  Server;
            proxy_pass_header  Date;
            proxy_pass         $upstream_scheme://apiok_backend$upstream_uri;
        }
    }
}
